<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SocialSphere | Profile</title>
    <link rel="icon" type="image/png" href="/logo_SS.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { theme: { extend: { colors: { darkbg: '#0d1117', cardbg: '#161b22', bordercol: '#30363d', accent: '#2f81f7' } } } }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0d1117; color: #e6edf3; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #0d1117; } ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
        /* Active class for profile page navigation */
        .nav-profile-item { border-bottom: 2px solid #e6edf3; color: #fff; } 
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="message-box" class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 z-50 p-3 px-6 max-w-sm rounded-full text-sm font-regular shadow-xl opacity-90 transition-all duration-300" role="alert"></div>

       <nav class="sticky top-0 z-50 bg-cardbg border-b border-bordercol px-4 h-16 flex items-center justify-center">
        <div class="max-w-7xl w-full flex items-center justify-between">
            
            <div class="flex items-center gap-4">
                 <a href="/"><img src="/logo_SS.png" alt="SocialShere Logo" class="h-10 w-auto mr-2"></a>


            </div>

            <ul class="flex items-center gap-1 sm:gap-6 text-gray-400 text-xs sm:text-sm font-medium">
                <li class="nav-item active flex flex-col items-center cursor-pointer hover:text-white transition h-16 justify-center px-2">
                    <a href="/" class="flex flex-col items-center"><svg class="w-6 h-6 mb-0.5" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg><span class="hidden md:block">Home</span></a>
                </li>
                <li class="nav-item flex flex-col items-center cursor-pointer hover:text-white transition h-16 justify-center px-2">
                    <a href="/jobs" class="flex flex-col items-center"><svg class="w-6 h-6 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg><span class="hidden md:block">Jobs</span></a>
                </li>
                <li class="nav-item flex flex-col items-center cursor-pointer hover:text-white transition h-16 justify-center px-2">
                    <a href="/messages" class="flex flex-col items-center"><svg class="w-6 h-6 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg><span class="hidden md:block">Messaging</span></a>
                </li>

                <li class="nav-item flex flex-col items-center cursor-pointer hover:text-white transition h-16 justify-center px-2 relative group">
                    <img src="<%= currentUser && currentUser.profilePicture ? currentUser.profilePicture : '/uploads/default-avatars/default.png' %>" alt="Me" class="w-6 h-6 rounded-full border border-gray-600 object-cover">
                    <span class="hidden md:block mt-0.5 text-xs flex items-center"><%= currentUser ? currentUser.username : 'Me' %> <svg class="w-3 h-3 ml-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></span>
                    
                    <div class="hidden group-hover:block absolute top-14 right-0 w-48 bg-cardbg border border-bordercol rounded-md shadow-xl py-2 z-50">
                        <a href="/profile" class="block px-4 py-2 hover:bg-gray-800 text-sm">View Profile</a>
                        <a href="#" class="block px-4 py-2 hover:bg-gray-800 text-sm">Settings</a>
                        <div class="border-t border-bordercol my-1"></div>
                        <a href="/logout" id="logout-btn" class="block px-4 py-2 hover:bg-gray-800 text-sm text-red-400">
                            Sign Out
                        </a>
                    </div>
                </li>
            </ul>
        </div>
    </nav>

    <div class="flex-grow w-full bg-darkbg px-4 py-6">

        <% if (isOwnProfile && !profileStatus.isComplete) { %>
            <div class="mb-6 p-4 bg-yellow-900/30 border border-yellow-700 rounded-lg flex items-start gap-3">
                <svg class="w-5 h-5 text-yellow-400 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                <div class="flex-grow">
                    <h3 class="font-semibold text-yellow-200 mb-1">Finish Setting Up Your Account</h3>
                    <p class="text-yellow-100 text-sm mb-2">Complete your profile to make a great first impression:</p>
                    <ul class="text-sm text-yellow-100 space-y-1 ml-4">
                        <% profileStatus.missingFields.forEach(field => { %>
                            <li>â€¢ Add your <strong><%= field %></strong></li>
                        <% }); %>
                    </ul>
                    <button id="complete-profile-btn" class="mt-3 px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg text-sm font-semibold transition">
                        Complete Now
                    </button>
                </div>
            </div>
        <% } %>

<div id="profile-content" class="w-full max-w-7xl mx-auto">

    <% if (user.isBlocked && (!currentUser || !currentUser.isAdmin)) { %>
        
        <div class="flex flex-col items-center justify-center py-20 bg-cardbg rounded-xl border border-bordercol">
            <div class="w-20 h-20 bg-red-900/30 rounded-full flex items-center justify-center mb-4">
                <svg class="w-10 h-10 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                </svg>
            </div>
            <h2 class="text-xl font-bold text-white">Account Suspended</h2>
            <p class="text-gray-400 mt-2">The user is blocked by a SocialSphere admin.</p>
        </div>

    <% } else { %> 
    <div id="profile-view-column" class="w-full space-y-6">
            <div class="bg-cardbg rounded-xl border border-bordercol overflow-hidden">
                <div class="h-64 bg-[url('/logo_bg_SS.png')] bg-cover bg-center"></div>
                <div class="p-6">
                    <div class="relative -mt-16 flex items-end gap-6"><div class="relative group">
                            <img id="profile-img-lg" 
                                 src="<%= user.profilePicture ? user.profilePicture : '/uploads/default-avatars/default.png' %>" 
                                 class="w-28 h-28 rounded-full border-4 border-cardbg shadow-lg object-cover">
                            
                            <% if (isOwnProfile) { %>
                                <div id="change-profile-pic-btn" 
                                     class="absolute inset-0 flex items-center justify-center bg-black/60 rounded-full opacity-0 group-hover:opacity-100 transition duration-200 cursor-pointer backdrop-blur-sm">
                                    <svg class="w-8 h-8 text-white/90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                </div>
                                <input type="file" id="profile-pic-input" name="profilePicture" accept="image/jpeg, image/png, image/webp, image/gif" class="hidden">
                            <% } %>
                        </div>
                        
                        <div class="flex flex-wrap gap-3 items-center">
                            <% if (isOwnProfile) { %>
                                <button id="edit-profile-btn" class="mb-2 px-4 py-1.5 border border-accent text-accent rounded-full text-sm font-semibold hover:bg-accent/10 transition">Edit Profile</button>
                                <button id="upload-resume-btn" class="mb-2 px-4 py-1.5 border border-accent text-accent rounded-full text-sm font-semibold hover:bg-accent/10 transition">
                                    <% if(user.resume){%>Update <%}else{%> Upload <% }%> Resume
                                </button>
                                <input type="file" id="resume-file-input" accept="application/pdf" style="display: none;" />
                            
                            <% } else { %>
                                <% if (connectionStatus.status === 'none') { %>
                                    <button id="connect-btn" class="mb-2 px-4 py-1.5 border border-accent text-accent rounded-full text-sm font-semibold hover:bg-accent/10 transition" data-user-id="<%= user.id %>">Connect</button>
                                <% } else if (connectionStatus.status === 'pending') { %>
                                    <% if (connectionStatus.isRequester) { %>
                                        <button class="mb-2 px-4 py-1.5 border border-gray-500 text-gray-500 rounded-full text-sm font-semibold cursor-not-allowed" disabled>Request Sent</button>
                                    <% } else { %>
                                        <button id="accept-btn" class="mb-2 px-4 py-1.5 border border-green-500 text-green-500 rounded-full text-sm font-semibold hover:bg-green-500/10 transition" data-connection-id="<%= connectionStatus.connection._id %>">Accept Request</button>
                                        <button id="decline-btn" class="mb-2 px-4 py-1.5 border border-red-500 text-red-500 rounded-full text-sm font-semibold hover:bg-red-500/10 transition" data-connection-id="<%= connectionStatus.connection._id %>">Decline</button>
                                    <% } %>
                                <% } else if (connectionStatus.status === 'accepted') { %>
                                    <button class="mb-2 px-4 py-1.5 border border-green-600 text-green-600 rounded-full text-sm font-semibold cursor-not-allowed" disabled>Connected</button>
                                <% } %>

                                <button id="message-btn" data-recipient-id="<%= user._id %>" class="mb-2 px-4 py-1.5 border border-accent text-accent rounded-full text-sm font-semibold hover:bg-accent/10 transition">Message</button>
                                
                                <% if (currentUser && currentUser.isAdmin) { %>
                                    <button 
                                        id="admin-block-btn" 
                                        data-user-id="<%= user._id %>" 
                                        data-is-blocked="<%= user.isBlocked %>"
                                        class="mb-2 px-4 py-1.5 border <%= user.isBlocked ? 'border-green-500 text-green-500 hover:bg-green-500/10' : 'border-red-500 text-red-500 hover:bg-red-500/10' %> rounded-full text-sm font-semibold transition"
                                    >
                                        <%= user.isBlocked ? 'Unblock User' : 'Block User' %>
                                    </button>
                                <% } %>
                                <% if (user.resume) { %>
                                    <a href="<%= user.resume %>" download="<%= user.username.split(' ')[0] %>_Resume" target="_blank" class="inline-block mb-2 px-4 py-1.5 border border-accent text-accent rounded-full text-sm font-semibold hover:bg-accent/10 transition cursor-pointer text-center no-underline">
                                        <i class="fas fa-download mr-2"></i> Download <%= user.username.split(" ")[0] %>'s Resume
                                    </a>
                                <% } else { %>
                                    <button class="mb-2 px-4 py-1.5 border border-gray-400 text-gray-400 rounded-full text-sm font-semibold cursor-not-allowed opacity-50">No Resume Available</button>
                                <% } %>
                            <% } %>
                        </div>
                    </div>

                    <h1 id="profile-name-display" class="text-3xl font-bold mt-4">
                        <%= user.username %>
                        <% if (user.isBlocked) { %> 
                            <span class="ml-2 text-xs border border-red-500 text-red-500 px-2 py-0.5 rounded uppercase">Blocked</span>
                        <% } %>
                    </h1>
                    <p id="profile-headline-display" class="text-gray-300 mt-1"><%= user.headline || 'No headline' %></p>
                    <p class="text-gray-500 text-sm mt-1"><%= user.email %></p>
                    <p id="profile-work-display" class="text-gray-400 text-sm mt-1 <%= user.work ? '' : 'hidden' %>"><%= user.work %></p>
                </div>
            </div>

            <div class="bg-cardbg rounded-xl border border-bordercol p-6 space-y-4">
                <h2 class="text-xl font-semibold">About</h2>
                <p id="profile-bio-display" class="text-gray-400 leading-relaxed"><%= user.bio || 'No description provided' %></p>
            </div>

            <% if (user.experiences && user.experiences.length > 0) { %>
                <div class="bg-cardbg rounded-xl border border-bordercol p-6 space-y-4">
                    <h2 class="text-xl font-semibold">Experience</h2>
                    <div class="space-y-6">
                        <% user.experiences.forEach(exp => { %>
                        <div class="border-l-2 border-accent pl-4">
                            <h3 class="text-lg font-semibold"><%= exp.title %></h3>
                            <p class="text-gray-300"><%= exp.company %></p>
                            <% if (exp.location) { %><p class="text-gray-500 text-sm"><%= exp.location %></p><% } %>
                            <p class="text-gray-500 text-sm">
                                <%= exp.startDate ? new Date(exp.startDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long' }) : '' %> - 
                                <%= exp.current ? 'Present' : (exp.endDate ? new Date(exp.endDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long' }) : '') %>
                            </p>
                            <% if (exp.description) { %><p class="text-gray-400 text-sm mt-2"><%= exp.description %></p><% } %>
                        </div>
                        <% }); %>
                    </div>
                </div>
            <% } %>
        </div>

        <% if (isOwnProfile) { %>
        <div id="edit-form-container" class="w-full max-w-2xl mx-auto space-y-6 hidden mt-6">
            <div class="bg-cardbg rounded-xl border border-bordercol p-6">
                <h2 class="text-xl font-semibold mb-4 text-accent">Edit Information</h2>
                
                <form id="profile-edit-form" class="space-y-4">
                    <div>
                        <label for="edit-name" class="block text-sm font-medium mb-1">Full Name</label>
                        <input type="text" id="edit-name" name="name" value="<%= user.username %>" class="w-full bg-darkbg border border-bordercol rounded-md p-2 text-white text-sm focus:ring-accent focus:border-accent" required>
                    </div>

                    <div>
                        <label for="edit-headline" class="block text-sm font-medium mb-1">Headline</label>
                        <input type="text" id="edit-headline" name="headline" placeholder="e.g., Senior Software Engineer at Tech Inc." value="<%= user.headline || '' %>" class="w-full bg-darkbg border border-bordercol rounded-md p-2 text-white text-sm focus:ring-accent focus:border-accent" maxlength="220">
                    </div>

                    <div>
                        <label for="edit-work" class="block text-sm font-medium mb-1">Current Work</label>
                        <input type="text" id="edit-work" name="work" placeholder="e.g., Tech Company Inc." value="<%= user.work || '' %>" class="w-full bg-darkbg border border-bordercol rounded-md p-2 text-white text-sm focus:ring-accent focus:border-accent" maxlength="500">
                    </div>
                    
                    <div>
                        <label for="edit-bio" class="block text-sm font-medium mb-1">Bio</label>
                        <textarea id="edit-bio" name="bio" rows="4" placeholder="Tell us about yourself..." class="w-full bg-darkbg border border-bordercol rounded-md p-2 text-white text-sm focus:ring-accent focus:border-accent" maxlength="2600"><%= user.bio || '' %></textarea>
                        <p class="text-xs text-gray-500 mt-1">Max 2600 characters</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-2">Experience</label>
                        <div id="experiences-container" class="space-y-3">
                            <% if (user.experiences && user.experiences.length > 0) { %>
                                <% user.experiences.forEach((exp, index) => { %>
                                    <div class="bg-darkbg p-3 rounded border border-bordercol space-y-2 experience-item">
                                        <input type="text" class="exp-title w-full bg-gray-800 border border-bordercol rounded p-1 text-white text-xs" placeholder="Job Title" value="<%= exp.title %>">
                                        <input type="text" class="exp-company w-full bg-gray-800 border border-bordercol rounded p-1 text-white text-xs" placeholder="Company" value="<%= exp.company %>">
                                        <input type="text" class="exp-location w-full bg-gray-800 border border-bordercol rounded p-1 text-white text-xs" placeholder="Location" value="<%= exp.location || '' %>">
                                        <div class="flex gap-2">
                                            <input type="date" class="exp-start flex-1 bg-gray-800 border border-bordercol rounded p-1 text-white text-xs" value="<%= exp.startDate ? exp.startDate.toISOString().split('T')[0] : '' %>">
                                            <input type="date" class="exp-end flex-1 bg-gray-800 border border-bordercol rounded p-1 text-white text-xs" value="<%= exp.endDate ? exp.endDate.toISOString().split('T')[0] : '' %>">
                                        </div>
                                        <label class="flex items-center gap-2 text-xs">
                                            <input type="checkbox" class="exp-current" <%= exp.current ? 'checked' : '' %>>
                                            <span class="text-gray-300">Currently working here</span>
                                        </label>
                                        <button type="button" class="remove-exp text-xs text-red-400 hover:text-red-300">Remove</button>
                                    </div>
                                <% }); %>
                            <% } %>
                        </div>
                        <button type="button" id="add-exp-btn" class="mt-2 text-xs text-accent hover:text-blue-400">+ Add Experience</button>
                    </div>

                    <div class="flex justify-end gap-3 pt-2">
                        <button type="button" id="cancel-edit-btn" class="px-4 py-2 border border-gray-600 text-gray-300 rounded-full text-sm font-semibold hover:bg-gray-800 transition">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-accent text-white rounded-full text-sm font-semibold hover:bg-blue-600 transition">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
        <% } %>

    <% } %> </div> 

<div id="userActionModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm">
    
    <div class="bg-[#1b1f23] border border-gray-700 w-full max-w-md rounded-xl shadow-2xl transform transition-all">
        <div class="p-6">
            <h3 id="userActionTitle" class="text-xl font-semibold text-gray-100 capitalize">
                Action Confirmation
            </h3>
            
            <p class="mt-3 text-gray-400">
                Are you sure you want to <span id="actionTextPlaceholder" class="font-bold text-white">perform this action</span> on this user?
            </p>
        </div>

        <div class="flex justify-end gap-3 p-4 bg-[#161b22] rounded-b-xl">
            <button id="userActionCancelBtn" 
                class="px-4 py-2 text-sm font-medium text-gray-300 hover:bg-gray-800 rounded-md transition-colors">
                Cancel
            </button>
            
            <button id="userActionConfirmBtn" 
                class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-500 rounded-md transition-colors shadow-sm capitalize">
                Confirm
            </button>
        </div>
    </div>
</div>

    <script>
        // --- TOAST MESSAGE FUNCTION ---
        const messageBox = document.getElementById('message-box');
        function displayMessage(message, type) {
            messageBox.textContent = message;
            messageBox.className = 'fixed bottom-4 left-1/2 -translate-x-1/2 z-50 p-3 px-6 max-w-sm rounded-full text-sm font-regular shadow-xl opacity-90 transition-all duration-300';
            
            if (type === 'error') {
                messageBox.classList.add('bg-red-600', 'text-white');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-600', 'text-white');
            } else {
                 messageBox.classList.add('bg-gray-800', 'text-white');
            }

            messageBox.classList.remove('hidden');
            
            setTimeout(() => {
                messageBox.classList.add('hidden');
                setTimeout(() => messageBox.className = 'hidden', 300); 
            }, 5000);
        }

        // --- PROFILE LOGIC ---
        const editFormContainer = document.getElementById('edit-form-container');
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const profileEditForm = document.getElementById('profile-edit-form');
        const profileViewColumn = document.getElementById('profile-view-column');
        const completeProfileBtn = document.getElementById('complete-profile-btn');
        const messageBtn = document.getElementById('message-btn') 
        const uploadBtn = document.getElementById('upload-resume-btn');
        const fileInput = document.getElementById('resume-file-input');
        const statusText = document.getElementById('upload-status');       
        // Handle "Complete Now" button click
        if (completeProfileBtn) {
            completeProfileBtn.addEventListener('click', () => {
                editProfileBtn.click();
                 // Trigger edit mode
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
        
        // Initialize profileData from passed user parameter
        let profileData = {
            name: "<%= user.username %>",
            headline: "<%= user.headline || '' %>",
            work: "<%= user.work || '' %>",
            bio: "<%= user.bio || '' %>"
        };


// --- EDIT MODE TOGGLE ---

if (editProfileBtn) {
        editProfileBtn.addEventListener('click', () => {
    
    // 1. Populate form fields
    document.getElementById('edit-name').value = profileData.name;
    document.getElementById('edit-headline').value = profileData.headline;
    document.getElementById('edit-work').value = profileData.work;
    document.getElementById('edit-bio').value = profileData.bio;

    // 2. Show the form container (Do this FIRST so it always works)
    editFormContainer.classList.remove('hidden');

    // 3. Hide the buttons (Check if they exist first to avoid errors)
    if (editProfileBtn) editProfileBtn.classList.add('hidden');
    if (messageBtn) messageBtn.classList.add('hidden'); 

    // 4. Scroll to the form
    requestAnimationFrame(() => {
        editFormContainer.scrollIntoView({
            behavior: 'smooth',
            block: 'center'
        });
    });

});
}
if (cancelEditBtn) {
                    cancelEditBtn.addEventListener('click', () => {
             // Hide form / Show view elements
            editFormContainer.classList.add('hidden');
            editProfileBtn.classList.remove('hidden');
            messageBtn.classList.remove('hidden');
        });
    }

        
    if (messageBtn) {
        // Message button handler
    messageBtn.addEventListener('click', async (e) => {
    const recipientId = e.currentTarget.getAttribute('data-recipient-id');

    try {
        const response = await fetch('/messages/conversation/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ recipientId })
            
        });

        const data = await response.json();

        if (data.success) {
            // Redirect to the messaging page with the conversation ID in a query param
            // or simply to the messages page where your logic will open the latest chat
            window.location.href = `/messages?open=${data.conversationId}`;
        } else {
            displayMessage(data.message || 'Failed to start conversation',"error");
        }
    } catch (err) {
        console.error('Error:', err);
        displayMessage('An error occurred while trying to open the conversation.',"error");
    }
});
    }       


   // 3. Upload Logic
    if (uploadBtn && fileInput) {
        
        // Trigger the hidden file input
        uploadBtn.addEventListener('click', (e) => {
            e.preventDefault();
            fileInput.click();
        });

        // Handle file selection
        fileInput.addEventListener('change', async () => {
            const file = fileInput.files[0];
            
            if (!file) return;

            // Validate PDF
            if (file.type !== 'application/pdf') {
                displayMessage('Only PDF files are allowed!', 'error');
                fileInput.value = ''; // Reset
                return;
            }

            // UI: Show loading
            const originalText = uploadBtn.innerHTML;
            uploadBtn.innerHTML = 'Uploading...';
            uploadBtn.disabled = true;

            const formData = new FormData();
            formData.append('resume', file);

            try {
                const response = await fetch('/profile/uploadresume', { 
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    displayMessage('Resume uploaded successfully!', 'success');
                    // Reload after 1.5s to show changes
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    displayMessage(result.message || 'Upload failed.', 'error');
                }
            } catch (err) {
                console.error(err);
                displayMessage('Network error. Please try again.', 'error');
            } finally {
                // Reset Button
                uploadBtn.innerHTML = originalText;
                uploadBtn.disabled = false;
                fileInput.value = ''; 
            }
        });
    }


        // Friend request button handler
        
        const connectBtn = document.getElementById('connect-btn');
       
        if (connectBtn) {
            connectBtn.addEventListener('click', async () => {
                const userId = connectBtn.getAttribute('data-user-id');
                console.log('Connect button clicked, userId:', userId);
                
                try {
                    const response = await fetch(`/user/connection/${userId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    console.log('Response status:', response.status);
                    const data = await response.json();
                    console.log('Response data:', data);

                    if (data.success) {
                        displayMessage('Connection request sent!', 'success');
                        connectBtn.textContent = 'Request Sent';
                        connectBtn.disabled = true;
                        connectBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                        displayMessage(data.message || 'Failed to send connection request', 'error');
                    }
                } catch (error) {
                    console.error('Connection request error:', error);
                    displayMessage('Network error: ' + error.message, 'error');
                }
            });
        }


        //block unblock users 
        const userActionModal = document.getElementById('userActionModal');
const userActionTitle = document.getElementById('userActionTitle');
const actionTextPlaceholder = document.getElementById('actionTextPlaceholder');
const userActionConfirmBtn = document.getElementById('userActionConfirmBtn');
const userActionCancelBtn = document.getElementById('userActionCancelBtn');

/**
 * Dynamic confirmation for user actions
 * @param {string} actionText - e.g. "block", "follow", "remove"
 */
function confirmUserAction(actionText) {
    return new Promise((resolve) => {
        // 1. INJECT THE TEXT DYNAMICALLY
        actionTextPlaceholder.textContent = actionText; 
        userActionTitle.textContent = `${actionText} User`; // Capitalizes title
        userActionConfirmBtn.textContent = `Yes, ${actionText}`;

        // 2. SHOW MODAL
        userActionModal.classList.remove('hidden');

        const handleConfirm = () => {
            closeModal();
            resolve(true);
        };

        const handleCancel = () => {
            closeModal();
            resolve(false);
        };

        const closeModal = () => {
            userActionModal.classList.add('hidden');
            userActionConfirmBtn.removeEventListener('click', handleConfirm);
            userActionCancelBtn.removeEventListener('click', handleCancel);
        };

        userActionConfirmBtn.addEventListener('click', handleConfirm);
        userActionCancelBtn.addEventListener('click', handleCancel);
    });
}


        const blockBtn = document.getElementById('admin-block-btn');

    
    if (blockBtn) {
        blockBtn.addEventListener('click', async () => {
            
            // Get data from the button's data attributes
            const userId = blockBtn.dataset.userId;
            const isBlockedString = blockBtn.dataset.isBlocked; 
            const currentStatus = isBlockedString === 'true'; 
            
            // Calculate the new status (flip the current status)
            const newStatus = !currentStatus;
            const actionText = newStatus ? 'BLOCK' : 'UNBLOCK';

            // 3. Confirm with the admin before proceeding
            const confirmed = await confirmUserAction(actionText);
            if (!confirmed) return;
            try {
                // 4. Send the request to your backend
                // IMPORTANT: Make sure this route matches your Backend Router!
                const response = await fetch(`/user/${userId}/block-status`, {
                    method: 'PUT', // or 'POST' depending on your backend
                    headers: { 
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({ isBlocked: newStatus })
                });

                const data = await response.json();

                if (response.ok) {
                    // Success! Reload the page to show the new view
                    displayMessage(`User successfully ${newStatus ? 'blocked' : 'unblocked'}`,"success");
                    setTimeout(() => {
                        window.location.reload(); 
                    }, 2000);
                    
                } else {
                    displayMessage(data.message || 'Error updating status', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                displayMessage('Server error occurred. Check console for details.',"error");
            }
        });
    }

        const changePicBtn = document.getElementById('change-profile-pic-btn');
    const imageInput = document.getElementById('profile-pic-input');
    const profileImg = document.getElementById('profile-img-lg');

    // Only execute if the elements exist (i.e., user is viewing their own profile)
    if (changePicBtn && imageInput) {
        
        // 1. Trigger the hidden file input when the overlay is clicked
        changePicBtn.addEventListener('click', () => {
            imageInput.click();
        });

        // 2. Listen for file selection changes
        imageInput.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            
            if (!file) return;

            // Simple validation
            if (!file.type.startsWith('image/')) {
                alert('Please select a valid image file (JPEG, PNG, GIF, WEBP).');
                return;
            }

            // prepare form data
            const formData = new FormData();
            formData.append('profilePicture', file);

           
            profileImg.style.opacity = '0.5';
            document.body.style.cursor = 'wait';

            try {
                
                const response = await fetch('/profile/upload-profile-picture', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include' 
                });

                const data = await response.json();

                if (data.success) {
                    // Update main profile image immediately
                    // We append a timestamp (?t=...) to force the browser to reload the image bypassing cache
                    const newSrc = data.profilePicture + '?t=' + new Date().getTime();
                    profileImg.src = newSrc;
                    displayMessage('Profile picture updated successfully!',"success");
                    // Optional: Update the small avatar in the navbar if it exists
                    const navImg = document.querySelector('nav .nav-item img');
                    if (navImg) navImg.src = newSrc;

                } else {
                    displayMessage('Upload failed: ' + data.message,"error");
                }
            } catch (error) {
                console.error('Error uploading image:', error);
                displayMessage('An error occurred while uploading the image.',"error");
            } finally {
                // Reset UI state
                profileImg.style.opacity = '1';
                document.body.style.cursor = 'default';
                fileInput.value = ''; // Reset input to allow selecting the same file again if needed
            }
        });
    }



        // --- FORM SUBMISSION ---
        if (profileEditForm) {
        profileEditForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // 1. Get new data from form
            const newHeadline = document.getElementById('edit-headline').value;
            const newWork = document.getElementById('edit-work').value;
            const newBio = document.getElementById('edit-bio').value;

            // 2. Get experiences data
            const experiences = [];
            document.querySelectorAll('.experience-item').forEach(item => {
                const title = item.querySelector('.exp-title').value;
                const company = item.querySelector('.exp-company').value;
                const location = item.querySelector('.exp-location').value;
                const startDate = item.querySelector('.exp-start').value;
                const endDate = item.querySelector('.exp-end').value;
                const current = item.querySelector('.exp-current').checked;

                if (title && company) {
                    experiences.push({
                        title, company, location, startDate, endDate, current
                    });
                }
            });

            // 3. Validate required fields
            if (!newHeadline.trim() || !newWork.trim() || !newBio.trim()) {
                displayMessage('Please fill in all required fields', 'error');
                return;
            }

            try {
                // 4. Send to backend API
                const response = await fetch('/profile/update', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        headline: newHeadline,
                        work: newWork,
                        bio: newBio,
                        experiences: experiences
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // 5. Update the local data
                    profileData.headline = newHeadline;
                    profileData.work = newWork;
                    profileData.bio = newBio;
                    
                    // 6. Update all display elements
                    updateProfileDisplay();
                    
                    // 7. Exit edit mode
                    cancelEditBtn.click();

                    // 8. Show success message
                    displayMessage('Profile updated successfully!', 'success');
                    
                    // 9. Reload page after short delay to show updated profile status
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    displayMessage(data.message || 'Failed to update profile', 'error');
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                displayMessage('Network error: ' + error.message, 'error');
            }
        });
    }

        // --- ADD EXPERIENCE HANDLER ---
        const addExpBtn = document.getElementById('add-exp-btn');
        if (addExpBtn) {
            addExpBtn.addEventListener('click', (e) => {
                e.preventDefault();
                const container = document.getElementById('experiences-container');
                const expDiv = document.createElement('div');
                expDiv.className = 'bg-darkbg p-3 rounded border border-bordercol space-y-2 experience-item';
                expDiv.innerHTML = `
                    <input type="text" class="exp-title w-full bg-gray-800 border border-bordercol rounded p-1 text-white text-xs" placeholder="Job Title">
                    <input type="text" class="exp-company w-full bg-gray-800 border border-bordercol rounded p-1 text-white text-xs" placeholder="Company">
                    <input type="text" class="exp-location w-full bg-gray-800 border border-bordercol rounded p-1 text-white text-xs" placeholder="Location">
                    <div class="flex gap-2">
                        <input type="date" class="exp-start flex-1 bg-gray-800 border border-bordercol rounded p-1 text-white text-xs">
                        <input type="date" class="exp-end flex-1 bg-gray-800 border border-bordercol rounded p-1 text-white text-xs">
                    </div>
                    <label class="flex items-center gap-2 text-xs">
                        <input type="checkbox" class="exp-current">
                        <span class="text-gray-300">Currently working here</span>
                    </label>
                    <button type="button" class="remove-exp text-xs text-red-400 hover:text-red-300">Remove</button>
                `;
                container.appendChild(expDiv);
                setupExpRemoveHandler(expDiv.querySelector('.remove-exp'));
                setupDateValidation(expDiv);
            });
        }

        // --- REMOVE EXPERIENCE HANDLER ---
        function setupExpRemoveHandler(btn) {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                btn.closest('.experience-item').remove();
            });
        }

        document.querySelectorAll('.remove-exp').forEach(btn => setupExpRemoveHandler(btn));

        // --- DATE VALIDATION FOR EXPERIENCES ---
        function setupDateValidation(expItem) {
            const startInput = expItem.querySelector('.exp-start');
            const endInput = expItem.querySelector('.exp-end');
            const currentCheckbox = expItem.querySelector('.exp-current');

            // When start date changes, set min for end date
            startInput.addEventListener('change', () => {
                if (startInput.value) {
                    endInput.min = startInput.value;
                    // If end date is before start date, clear it
                    if (endInput.value && endInput.value < startInput.value) {
                        endInput.value = '';
                    }
                } else {
                    endInput.removeAttribute('min');
                }
            });

            // When end date changes, set max for start date
            endInput.addEventListener('change', () => {
                if (endInput.value) {
                    startInput.max = endInput.value;
                    // If start date is after end date, clear it
                    if (startInput.value && startInput.value > endInput.value) {
                        startInput.value = '';
                    }
                } else {
                    startInput.removeAttribute('max');
                }
            });

            // Handle current checkbox
            currentCheckbox.addEventListener('change', () => {
                if (currentCheckbox.checked) {
                    endInput.value = '';
                    endInput.disabled = true;
                } else {
                    endInput.disabled = false;
                }
            });

            // Initial setup
            if (currentCheckbox.checked) {
                endInput.disabled = true;
            }
            if (startInput.value) {
                endInput.min = startInput.value;
            }
            if (endInput.value) {
                startInput.max = endInput.value;
            }
        }

        // Setup date validation for existing experiences
        document.querySelectorAll('.experience-item').forEach(setupDateValidation);

        function updateProfileDisplay() {
            document.getElementById('profile-name-display').textContent = profileData.name;
            document.getElementById('profile-headline-display').textContent = profileData.headline || 'No headline';
            const workDisplay = document.getElementById('profile-work-display');
            if (profileData.work) {
                workDisplay.textContent = profileData.work;
                workDisplay.classList.remove('hidden');
            } else {
                workDisplay.classList.add('hidden');
            }
            document.getElementById('profile-bio-display').textContent = profileData.bio || 'No description provided';
        }

        // Initial load to populate the display
        updateProfileDisplay();

        
                
        


        
    </script>
</body>
</html>